[< back to README.md](../README.md)
# Phase 1: Core LAN Features

This document explains the detailed steps to implement **Phase 1** of the Internet Caf√© System.

## üéØ Goal of Phase 1

Build a **Local Server + Client App** that works over LAN, with the following features:

* Clients log in using a **code** generated by the server.
* Timer countdown runs on client PCs.
* Alarm + lock screen when time runs out.
* Admin can manage client sessions (start, extend, end).
* Clients can **send requests** (e.g., extension) or **chat with server**.

## üìÇ Project Structure Setup

The following structure will be used as the **canonical plan**. All phases build on this.

```
/internet-cafe-system
‚îÇ‚îÄ‚îÄ /server-app        # Admin / Local Caf√© Server  
‚îÇ‚îÄ‚îÄ /client-app        # Client PC Application  
‚îÇ‚îÄ‚îÄ /docs              # Documentation (README, Phase1.md, etc.)  
‚îÇ‚îÄ‚îÄ InternetCafe.sln   # Visual Studio solution file  
```

### Server App (Admin PC)

```
/server-app  
‚îÇ‚îÄ‚îÄ Program.cs                # Entry point  
‚îÇ‚îÄ‚îÄ App.config                # Configurations (DB path, ports, etc.)  
‚îÇ  
‚îú‚îÄ‚îÄ /Forms  
‚îÇ   ‚îú‚îÄ‚îÄ MainForm.cs           # Main admin dashboard  
‚îÇ   ‚îú‚îÄ‚îÄ ClientListForm.cs     # List of connected clients  
‚îÇ   ‚îú‚îÄ‚îÄ SessionControlForm.cs # Start/extend/end sessions  
‚îÇ  
‚îú‚îÄ‚îÄ /Database  
‚îÇ   ‚îú‚îÄ‚îÄ Database.cs           # SQLite connection handler  
‚îÇ   ‚îú‚îÄ‚îÄ SessionModel.cs       # Session entity  
‚îÇ   ‚îú‚îÄ‚îÄ ClientModel.cs        # Client entity  
‚îÇ   ‚îú‚îÄ‚îÄ Migrations/           # DB schema updates  
‚îÇ  
‚îú‚îÄ‚îÄ /Networking  
‚îÇ   ‚îú‚îÄ‚îÄ ServerSocket.cs       # TCP/SignalR server  
‚îÇ   ‚îú‚îÄ‚îÄ MessageProtocol.cs    # Defines JSON message formats  
‚îÇ   ‚îú‚îÄ‚îÄ EncryptionHelper.cs   # Simple message encryption  
‚îÇ  
‚îî‚îÄ‚îÄ /Utils  
    ‚îú‚îÄ‚îÄ CodeGenerator.cs      # Creates unique session codes  
    ‚îú‚îÄ‚îÄ TimerManager.cs       # Handles server-side timers  
    ‚îú‚îÄ‚îÄ Logger.cs             # Logs events and errors  
```

### Client App (Customer PC)

```
/client-app  
‚îÇ‚îÄ‚îÄ Program.cs                # Entry point  
‚îÇ‚îÄ‚îÄ App.config                # Configurations (server IP, port, etc.)  
‚îÇ  
‚îú‚îÄ‚îÄ /Forms  
‚îÇ   ‚îú‚îÄ‚îÄ LoginForm.cs          # Enter session code  
‚îÇ   ‚îú‚îÄ‚îÄ TimerForm.cs          # Shows countdown timer  
‚îÇ   ‚îú‚îÄ‚îÄ LockScreenForm.cs     # Fullscreen lock when time is up  
‚îÇ  
‚îú‚îÄ‚îÄ /Networking  
‚îÇ   ‚îú‚îÄ‚îÄ ClientSocket.cs       # Connects to server  
‚îÇ   ‚îú‚îÄ‚îÄ MessageHandler.cs     # Processes server commands  
‚îÇ   ‚îú‚îÄ‚îÄ EncryptionHelper.cs   # Matches server‚Äôs encryption  
‚îÇ  
‚îú‚îÄ‚îÄ /Session  
‚îÇ   ‚îú‚îÄ‚îÄ SessionManager.cs     # Handles login, start, extend, expire  
‚îÇ   ‚îú‚îÄ‚îÄ AlarmManager.cs       # Popup + sound warning before time ends  
‚îÇ   ‚îú‚îÄ‚îÄ LockManager.cs        # Activates lock screen overlay  
‚îÇ  
‚îî‚îÄ‚îÄ /Utils  
    ‚îú‚îÄ‚îÄ ConfigHelper.cs       # Reads/writes config (server IP, etc.)  
    ‚îú‚îÄ‚îÄ Logger.cs             # Logs events locally  
```

---

## üîó JSON Protocol Specification

All communication between **Server ‚Üî Client** will use **JSON messages** over TCP/SignalR.
Each message must include:

* `type`: The command or event name.
* `payload`: Object containing relevant data.
* `timestamp`: UTC time when message was sent.
* `requestId`: Unique ID for matching request/response.

### 1. Session Management

#### Start Session (Server ‚Üí Client)

```json
{
  "type": "START_SESSION",
  "requestId": "srv-12345",
  "timestamp": "2025-09-19T10:00:00Z",
  "payload": {
    "sessionCode": "ABCD1234",
    "durationMinutes": 60,
    "clientId": "PC-05"
  }
}
```

#### Extend Session (Server ‚Üí Client)

```json
{
  "type": "EXTEND_SESSION",
  "requestId": "srv-12346",
  "timestamp": "2025-09-19T10:30:00Z",
  "payload": {
    "extraMinutes": 30
  }
}
```

#### End/Lock Session (Server ‚Üí Client)

```json
{
  "type": "LOCK_CLIENT",
  "requestId": "srv-12347",
  "timestamp": "2025-09-19T11:00:00Z",
  "payload": {
    "reason": "Time expired"
  }
}
```

### 2. Client Requests

#### Login Attempt (Client ‚Üí Server)

```json
{
  "type": "LOGIN_REQUEST",
  "requestId": "cli-001",
  "timestamp": "2025-09-19T10:05:00Z",
  "payload": {
    "sessionCode": "ABCD1234",
    "clientId": "PC-05"
  }
}
```

#### Request Extension (Client ‚Üí Server)

```json
{
  "type": "EXTENSION_REQUEST",
  "requestId": "cli-002",
  "timestamp": "2025-09-19T10:45:00Z",
  "payload": {
    "requestedMinutes": 30,
    "message": "Can I add 30 more minutes?"
  }
}
```

### 3. Messaging/Chat

#### Client to Server Chat

```json
{
  "type": "CHAT_MESSAGE",
  "requestId": "cli-003",
  "timestamp": "2025-09-19T10:50:00Z",
  "payload": {
    "from": "PC-05",
    "to": "SERVER",
    "message": "Need assistance, my keyboard is not working."
  }
}
```

#### Server to Client Chat

```json
{
  "type": "CHAT_MESSAGE",
  "requestId": "srv-12348",
  "timestamp": "2025-09-19T10:51:00Z",
  "payload": {
    "from": "SERVER",
    "to": "PC-05",
    "message": "We will check your keyboard shortly."
  }
}
```

### 4. Status Updates

#### Client Heartbeat (Client ‚Üí Server)

```json
{
  "type": "HEARTBEAT",
  "requestId": "cli-004",
  "timestamp": "2025-09-19T10:55:00Z",
  "payload": {
    "clientId": "PC-05",
    "remainingMinutes": 15,
    "status": "ACTIVE"
  }
}
```

#### Acknowledgement (Server ‚Üî Client)

```json
{
  "type": "ACK",
  "requestId": "srv-12346",
  "timestamp": "2025-09-19T10:30:01Z",
  "payload": {
    "status": "SUCCESS",
    "details": "Extension granted"
  }
}
```

---

## ‚ö° Folder Creation Script (Windows PowerShell)

Run the following commands in PowerShell to generate the full structure:

```powershell
# Create root repository
mkdir internet-cafe-system
cd internet-cafe-system

# Create main folders
mkdir server-app, client-app, docs

# Create placeholder Visual Studio solution file
New-Item InternetCafe.sln -ItemType File

# -----------------------
# Server App (Admin PC)
# -----------------------
cd server-app
New-Item Program.cs -ItemType File
New-Item App.config -ItemType File
mkdir Forms, Database, Networking, Utils

# Forms
cd Forms
New-Item MainForm.cs -ItemType File
New-Item ClientListForm.cs -ItemType File
New-Item SessionControlForm.cs -ItemType File
cd ..

# Database
cd Database
New-Item Database.cs -ItemType File
New-Item SessionModel.cs -ItemType File
New-Item ClientModel.cs -ItemType File
mkdir Migrations
cd ..

# Networking
cd Networking
New-Item ServerSocket.cs -ItemType File
New-Item MessageProtocol.cs -ItemType File
New-Item EncryptionHelper.cs -ItemType File
cd ..

# Utils
cd Utils
New-Item CodeGenerator.cs -ItemType File
New-Item TimerManager.cs -ItemType File
New-Item Logger.cs -ItemType File
cd ../..

# -----------------------
# Client App (Customer PC)
# -----------------------
cd client-app
New-Item Program.cs -ItemType File
New-Item App.config -ItemType File
mkdir Forms, Networking, Session, Utils

# Forms
cd Forms
New-Item LoginForm.cs -ItemType File
New-Item TimerForm.cs -ItemType File
New-Item LockScreenForm.cs -ItemType File
cd ..

# Networking
cd Networking
New-Item ClientSocket.cs -ItemType File
New-Item MessageHandler.cs -ItemType File
New-Item EncryptionHelper.cs -ItemType File
cd ..

# Session
cd Session
New-Item SessionManager.cs -ItemType File
New-Item AlarmManager.cs -ItemType File
New-Item LockManager.cs -ItemType File
cd ..

# Utils
cd Utils
New-Item ConfigHelper.cs -ItemType File
New-Item Logger.cs -ItemType File
cd ../..
```

---

## ‚úÖ Deliverable for Step 1

After running the script, you will have the **canonical folder structure** with placeholder files **plus a JSON protocol reference** for implementing communication.  This ensures coding can begin with clear guidelines.

## make a minimal working prototype:

### Step 1: Establish Socket Communication
- [x] Implement `ServerSocket.cs` (server listens for client connections).
- [x] Implement `ClientSocket.cs` (client connects to server).
- [x] Implement `server-app.Tests/MessageProtocolTests.cs` (shared JSON serialization/deserialization).
  - [x] converting TestMessageProtocol.cs into a unit test style file
    ```shell
    dotnet new xunit -n server-app.Tests
    dotnet sln add server-app.Tests/server-app.Tests.csproj
    dotnet add server-app.Tests/server-app.Tests.csproj reference server-app/server-app.csproj
    ```
  - [x] `server-app` and `client-app` inside `.csproj`
    ```xml
    <ItemGroup>
      <ProjectReference Include="..\CafeMate.Shared\CafeMate.Shared.csproj" />
    </ItemGroup>
    ```
  - [x] refactor existing TestMessageProtocol.cs into this test format directly using `public class MessageProtocolTests` isntead of `main()`
  - [x] migrate the rest of TestMessageProtocol.cs into proper unit tests
      ```csharp
      // ‚úÖ New style (xUnit unit test in MessageProtocolTests.cs)
      [Fact]
      public void SerializeAndDeserialize_RoundTrip_Works()
      {
          var msg = new Message { Type = "HELLO", Content = "World" };
          string json = MessageProtocol.Serialize(msg);
          var copy = MessageProtocol.Deserialize<Message>(json);

          Assert.Equal("HELLO", copy.Type);
          Assert.Equal("World", copy.Content);
      }
      ```
  - [x] `dotnet test`
  - [x] `dotnet run --project server-app` 
    - [x] Server starts, listens, and stays open.
    - [x] Server receives and prints the client‚Äôs hello.
  - [x] `dotnet run --project client-app` (with error)
    - [x] Client connects successfully.
    - [x] Client receives greeting message.
    - [x] Client sends back its own hello.
- [x] Test sending/receiving a basic ‚ÄúHELLO‚Äù message.

    - [x] `cd cafe-mate\internet-cafe-system`
    - [x] `dotnet new sln -n InternetCafe` Create a new solution file `./InternetCafe.sln`
    - [x] `dotnet new winforms -n server-app` Create projects `internet-cafe-system\server-app\server-app.csproj`
    - [x] `dotnet new winforms -n client-app` Create projects `internet-cafe-system\client-app\client-app.csproj`
    - [x] `dotnet sln InternetCafe.sln add server-app/server-app.csproj` Add projects to the solution
    - [x] `dotnet sln InternetCafe.sln add client-app/client-app.csproj` Add projects to the solution
    - [x] `dotnet build InternetCafe.sln` build  
    or
    - [ ] run this PowerShell script [init-phase1](init-phase1.ps1)
  

```shell
dotnet clean
dotnet build
dotnet run
```
#### Troubleshooting error CS0017:
    ```shell
    Select-String -Path .\* -Pattern "static void Main" # search all files for static void Main
    ```
    instead of deleting, Keep It, but Exclude from Compilation
    Edit `server-app.csproj` and add:

    ```xml
    <ItemGroup>
      <Compile Remove="TestMessageProtocol.cs" />
    </ItemGroup>
    ```

### Step 2: Implement Session Basics
- ***Project Setup & Testing***
  - [X] Test project must reference the server project
    - [X] `dotnet add server-app.Tests/server-app.Tests.csproj reference server-app/server-app.csproj`
    - [X] dotnet test
    - [x] dotnet build
  - [ ] `dotnet run --project server-app` (closing when client is connected)
  - [ ] `dotnet run --project client-app` (Unable to read data)
- ***Message Protocol Updates***
  - **Server-side**  
    - [ ] Extend Message.Type enum (or string values) to include:  
      - [ ] "`START_SESSION`"  
      - [ ] "`SESSION_STARTED`"  
- ***Server-Side Logic***
  - **Server-side** 
  - [ ] Update ServerSocket to handle "`START_SESSION`":  
      - [ ] When received from client, log it (`[Server] Received: START_SESSION`). 
      - [ ] Respond with a Message `{ Type = "SESSION_STARTED", Content = "Session has begun." }`.  
- ***Client-Side Logic***
  - **Client-side**  
    - [ ] Update `ClientSocket` to send a `START_SESSION` command after connecting (for now you can trigger it automatically, later via a button).  
    - [ ] Handle "`SESSION_STARTED`" response:  
      - [ ] Open `TimerForm.cs` (WinForms form).  
      - [ ] Start a countdown timer (for testing, maybe 10 seconds).  
      - [ ] Display the remaining time in a label.  
- ***UI Implementation (TimerForm.cs)***
  - [ ] Add a `Label` (for time left).  
  - [ ] Add a `Timer` component (`System.Windows.Forms.Timer`).  
  - [ ] On `Tick`, decrease remaining time and update the label.  
  - [ ] When timer reaches 0, show a messagebox ("`Session ended`") and stop timer. 


### Step 3: Add Chat (extension request)
- [ ] Client sends `CHAT_MESSAGE` ‚Üí ‚ÄúPlease extend my session.‚Äù
- [ ] Server can reply via `CHAT_MESSAGE`.